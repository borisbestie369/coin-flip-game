<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Coin Flip P2P</title>
    
    <!-- PeerJS for direct connection (No database required) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --coin-gold: #eab308;
            --btn-primary: #eab308;
            --btn-disabled: #475569;
            --panel-bg: #1e293b;
        }
        :root { color-scheme: dark; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100dvh;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        .bg-blob {
            position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; opacity: 0.15;
            background: radial-gradient(circle at 20% 20%, #9333ea 0%, transparent 40%),
                        radial-gradient(circle at 80% 80%, #2563eb 0%, transparent 40%);
        }

        .app-container {
            width: 100%; max-width: 400px; display: flex; flex-direction: column;
            align-items: center; gap: 1.5rem; padding: 1rem; z-index: 10;
        }
        
        .header h1 {
            font-size: 2rem; font-weight: 900; color: #fde047;
            text-transform: uppercase; letter-spacing: 1px; text-align: center;
        }

        /* Coin 3D */
        .perspective-container {
            perspective: 1000px; width: 200px; height: 200px;
            position: relative; margin: 1rem 0;
        }
        .coin {
            width: 100%; height: 100%;
            position: relative; transform-style: preserve-3d;
            border-radius: 50%;
            transition: transform 3000ms cubic-bezier(0.25, 1, 0.5, 1);
        }
        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 4px solid; background-color: #1e293b;
        }
        .face-heads { border-color: #ca8a04; background: linear-gradient(135deg, #fde047, #eab308); transform: rotateY(0deg); }
        .face-tails { border-color: #64748b; background: linear-gradient(135deg, #cbd5e1, #94a3b8); transform: rotateY(180deg); }
        .face-text { font-size: 5rem; font-weight: bold; font-family: serif; color: rgba(255,255,255,0.9); }
        
        .status-badge {
            background: rgba(0,0,0,0.3); padding: 0.5rem 1rem; border-radius: 20px;
            font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.5rem;
            border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-dot.connecting { background: #fde047; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        .controls { width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        
        button {
            border: none; outline: none; cursor: pointer; font-family: inherit;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 700; border-radius: 12px; transition: all 0.2s;
        }
        button:active { transform: scale(0.98); }

        .btn-main {
            background-color: var(--btn-primary); color: #0f172a; padding: 1rem;
            font-size: 1.1rem; width: 100%; box-shadow: 0 4px 0 #a16207;
        }
        .btn-main:disabled {
            background-color: var(--btn-disabled); color: #94a3b8;
            box-shadow: none; cursor: not-allowed; transform: translateY(4px);
        }

        .share-box {
            display: flex; gap: 8px; background: rgba(0,0,0,0.3); padding: 4px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .share-input {
            background: transparent; border: none; color: #94a3b8; font-family: monospace;
            font-size: 0.8rem; width: 100%; padding: 0 8px; outline: none;
        }
        .btn-copy-small {
            background: #334155; color: white; padding: 8px 12px;
            border-radius: 8px; font-size: 0.8rem; white-space: nowrap;
        }

        .stats {
            width: 100%; background: var(--panel-bg);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 1rem;
        }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .history { display: flex; justify-content: center; gap: 8px; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); min-height: 40px; }
        .bubble { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }
        .bubble-h { background: #eab308; color: #422006; }
        .bubble-t { background: #94a3b8; color: #0f172a; }

        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #334155; color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 100; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="bg-blob"></div>

    <div class="app-container">
        
        <div class="status-badge">
            <div id="statusDot" class="status-dot connecting"></div>
            <span id="playerStatus">Initializing...</span>
        </div>

        <div class="header">
            <h1>Coin Flip</h1>
        </div>

        <div class="perspective-container">
            <div id="coin" class="coin">
                <div class="face face-heads"><span class="face-text">H</span></div>
                <div class="face face-tails"><span class="face-text">T</span></div>
            </div>
        </div>

        <div class="controls">
            <button id="flipBtn" class="btn-main" disabled>WAITING FOR CONNECTION...</button>
            
            <div class="share-box" id="shareSection">
                <input type="text" id="linkInput" class="share-input" readonly value="Creating room...">
                <button id="copyLinkBtn" class="btn-copy-small">Copy</button>
            </div>
        </div>

        <div class="stats">
            <div class="stats-row">
                <span style="color: #facc15">HEADS: <span id="headsCount">0</span></span>
                <span style="color: #cbd5e1">TAILS: <span id="tailsCount">0</span></span>
            </div>
            <div class="history" id="historyContainer">
                <span style="font-size: 12px; color: #64748b;">No history yet</span>
            </div>
        </div>
    </div>

    <div id="toast">Link copied!</div>

    <script>
        // --- Game State ---
        const state = {
            angle: 0,
            counts: { heads: 0, tails: 0 },
            history: [],
            isFlipping: false
        };
        
        let peer = null;
        let conn = null;
        let myId = null;
        let hostId = null;
        let isHost = false;

        // --- DOM Elements ---
        const coin = document.getElementById('coin');
        const flipBtn = document.getElementById('flipBtn');
        const headsCount = document.getElementById('headsCount');
        const tailsCount = document.getElementById('tailsCount');
        const historyContainer = document.getElementById('historyContainer');
        const linkInput = document.getElementById('linkInput');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const toast = document.getElementById('toast');
        const statusDot = document.getElementById('statusDot');
        const playerStatus = document.getElementById('playerStatus');
        const shareSection = document.getElementById('shareSection');

        // --- Init ---
        function init() {
            // Check if we are joining a game
            const urlParams = new URLSearchParams(window.location.search);
            hostId = urlParams.get('g');

            if (hostId) {
                // WE ARE GUEST
                isHost = false;
                initPeer();
                shareSection.style.display = 'none'; // Guests don't share the link usually
                playerStatus.innerText = "Connecting to Host...";
            } else {
                // WE ARE HOST
                isHost = true;
                initPeer();
                playerStatus.innerText = "Creating Room...";
            }
        }

        function initPeer() {
            // Create Peer instance (connects to free public PeerJS server)
            peer = new Peer(null, {
                debug: 1
            });

            peer.on('open', (id) => {
                myId = id;
                console.log('My peer ID is: ' + id);

                if (isHost) {
                    // Host Ready
                    playerStatus.innerText = "Waiting for friend...";
                    statusDot.className = 'status-dot'; // Red (waiting)
                    
                    // Update URL box
                    const url = window.location.href.split('?')[0] + '?g=' + id;
                    linkInput.value = url;
                    
                    // Enable flip for host solo play if they want
                    enableFlipBtn("FLIP COIN");
                } else {
                    // Guest Ready -> Connect to Host
                    connectToHost();
                }
            });

            peer.on('connection', (connection) => {
                // Only Host receives connections typically
                if (conn) { conn.close(); } // Only support 1v1 for simplicity
                
                conn = connection;
                setupConnection();
                
                playerStatus.innerText = "Friend Connected!";
                statusDot.className = 'status-dot online';
                
                // Send current state to new guest
                sendState();
            });

            peer.on('error', (err) => {
                console.error(err);
                playerStatus.innerText = "Connection Error";
                statusDot.className = 'status-dot'; 
            });
        }

        function connectToHost() {
            if (!hostId) return;
            conn = peer.connect(hostId);
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => {
                console.log("Connected to peer");
                playerStatus.innerText = "Connected!";
                statusDot.className = 'status-dot online';
                
                if (!isHost) {
                    // Ask for state immediately
                    conn.send({ type: 'REQUEST_STATE' });
                    enableFlipBtn("FLIP COIN");
                }
            });

            conn.on('data', (data) => {
                handleData(data);
            });

            conn.on('close', () => {
                playerStatus.innerText = "Peer Disconnected";
                statusDot.className = 'status-dot';
            });
        }

        // --- Logic ---

        function handleData(data) {
            console.log("Received:", data);
            
            if (data.type === 'STATE_UPDATE') {
                // Sync State
                state.angle = data.payload.angle;
                state.counts = data.payload.counts;
                state.history = data.payload.history;
                state.isFlipping = data.payload.isFlipping;
                updateUI();
            } else if (data.type === 'FLIP_REQUEST') {
                // Host receives request to flip
                if (isHost && !state.isFlipping) {
                    performFlip();
                }
            } else if (data.type === 'REQUEST_STATE') {
                if (isHost) sendState();
            }
        }

        function sendState() {
            if (conn && conn.open) {
                conn.send({
                    type: 'STATE_UPDATE',
                    payload: state
                });
            }
        }

        function performFlip() {
            if (state.isFlipping) return;

            // 1. Set Flipping State
            state.isFlipping = true;
            disableFlipBtn();
            
            // 2. Logic
            const randomVal = Math.random();
            const outcome = randomVal > 0.5 ? 'tails' : 'heads';
            
            const baseRotation = 1800 + (Math.floor(Math.random() * 3) * 360); 
            let nextAngle = state.angle + baseRotation;
            const currentMod = nextAngle % 360;

            if (outcome === 'heads') {
                nextAngle += (360 - currentMod);
            } else {
                nextAngle += (180 - currentMod) + 360; 
            }
            
            state.angle = nextAngle;

            // 3. Broadcast Start (with new angle)
            // We update state locally and send it
            updateUI();
            sendState();

            // 4. Wait and Finalize
            setTimeout(() => {
                state.isFlipping = false;
                state.counts[outcome]++;
                state.history.unshift(outcome);
                if (state.history.length > 5) state.history.pop();
                
                updateUI();
                sendState();
                enableFlipBtn("FLIP COIN");
            }, 3000);
        }

        // --- UI Updates ---

        function updateUI() {
            // Coin
            coin.style.transform = `rotateY(${state.angle}deg)`;
            
            // Stats
            headsCount.innerText = state.counts.heads;
            tailsCount.innerText = state.counts.tails;
            
            // History
            if (state.history.length === 0) {
                historyContainer.innerHTML = '<span style="font-size: 12px; color: #64748b;">No history yet</span>';
            } else {
                historyContainer.innerHTML = '';
                state.history.forEach(h => {
                    const b = document.createElement('div');
                    b.className = `bubble ${h === 'heads' ? 'bubble-h' : 'bubble-t'}`;
                    b.innerText = h.charAt(0).toUpperCase();
                    historyContainer.appendChild(b);
                });
            }

            // Button State
            if (state.isFlipping) {
                disableFlipBtn();
            } else {
                // Only enable if we are connected or are host
                if (isHost || (conn && conn.open)) {
                    enableFlipBtn("FLIP COIN");
                }
            }
        }

        function disableFlipBtn() {
            flipBtn.disabled = true;
            flipBtn.innerText = "FLIPPING...";
        }

        function enableFlipBtn(text) {
            flipBtn.disabled = false;
            flipBtn.innerText = text;
        }

        // --- Interaction ---

        flipBtn.addEventListener('click', () => {
            if (state.isFlipping) return;

            if (isHost) {
                performFlip();
            } else {
                // Guest requests flip
                if (conn && conn.open) {
                    conn.send({ type: 'FLIP_REQUEST' });
                    disableFlipBtn(); // Optimistic disable
                }
            }
        });

        copyLinkBtn.addEventListener('click', () => {
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            if (navigator.clipboard) {
                navigator.clipboard.writeText(linkInput.value);
            } else {
                document.execCommand("copy");
            }
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        });

        // Start
        init();

    </script>
</body>
</html>